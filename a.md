# OhMyPermission

`OhMyPermission` 是一个基于 Android 平台的权限框架，他诞生于 `电信集成公司2018软件开发技能竞赛`，作者团队是 `天生一队`，来自移动互联网事业部。

框架的设计理念是基于团队在移动应用研发中的产品经验和技术沉淀，团队成立的时候，没有把它简单定位成一个比赛用的 Demo，也希望它有机会成为一个标准组件，为公司的共享研发体系做出贡献。

本文被拆分为以下几个部分：

#### 1. 为什么需要 _OhMyPermission_

#### 2. 权限模型

#### 3. 消灭代码中的 IF-ELSE 风暴

#### 4. 设计原则

#### 5. 模块设计

#### 6. 设计优化

#### 7. 展望

---

## 1. 为什么需要 _OhMyPermission_

对于多租户的运营型 Saas 产品，经常需要灵活的分权分域模型来支撑不同的定制化需求和产品形态。这里包括但不限于：

- `版本`的差异

- `增值业务`的差异

- `菜单、功能、操作`的差异

- `角色`的差异。

- `平台`的差异

**以上仅仅列举了一个平台内需要处理的问题，不同的平台将面临不同的问题**

为了实现这些需求，开发者不得不在移动端的处理`不同的菜单` 、 `控件的渲染` 、`操作的逻辑`，添加对`多版本`、`多角色`、`多平台`的业务逻辑，当解决掉当前产品的所有问题后，我们会发现另一个产品或许采用了另一个权限模型。而且代码同时也会产生大面积的`if-else风暴`，变得难以维护。

*OhMyPermission*框架被设计用来解决/缓解上述问题，经过讨论后，我们达成了一个共识，而整个框架的设计都建立在这个个共识上：

#### 对于客户端来说，任何业务侧的权限管理中的组件，如版本、角色、功能等，都可以抽象为：全局唯一的 URI 的集合

---

## 2. 权限模型：所有权限都是全局唯一 URI

### 2.1 复杂的业务权限模型

![](https://doulala.oss-cn-qingdao.aliyuncs.com/image/%E5%B9%B3%E5%8F%B0%E6%9D%83%E9%99%90%E6%A8%A1%E5%9E%8B.jpg)

1. 一个`产品`平台可以包含 1-N 个`版本`。每个租户（企业）属于一个版本。

2. 每个`版本`可以包括 1-N 个权限，`版本`可以通过添加`版本扩展`进行定制需求、灰度版本的发布。

3. `功能`是版本和权限之间的中间媒介，可以通过前端逻辑帮助用户快速关联，可以不在表结构中提现

4. 每个`角色`对应的权限是租户版本对应的权限集合的子集，一个角色可以有 1-N 个权限。

5. 每个`用户`可以包括 1-N 个角色。用户的权限是所有分配角色对应权限的集合。

### 2.2 简化的客户端权限模型

![](https://doulala.oss-cn-qingdao.aliyuncs.com/image/%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%9D%83%E9%99%90%E6%A8%A1%E5%9E%8B.jpg)

1. 模型定义`权限`是一个全局唯一的 uri，在面对不同来源和不同模型的权限框架，只要最终处理成多组 uri 的集合，就可以统一使用权限模型进行权限管理。

2. 权限呈现了`key-list`的结构，其中`key`是权限组名称，`list`是对应的权限列表。

3. 模型定义了权限仓库`storage`,以`key`为管理单元存储所有客户端上的权限，并提供持久化和缓存管理，并支持按`key`进行局部更新，维护了一套当前生效的`key`的集合。

4. 模型定义了权限验证`validator`，主要提供对权限表达式的校验能力及表达式结果缓存管理。

5. 用户通过`validator`定义`权限管理范围`，通过`storegae`进行`权限内容`进行更新。

> `validator`与`storage`内部缓存管理和之间数据同步数据具体代码实现，同步需要借助`bus`和`PermissionManager`的进行调度，不在模型讨论范围内。

---

## 3. 消灭代码中的 IF-ELSE 风暴

`IF-ELSE风暴`是我们提出的一个编程现象，在实现权限的管理逻辑时，需要大量的`if-else`操作来对不同权限进行处理。

_OhMyPermission_ 的目标是提供简单但足够使用的权限管理框架，第一期需要提供能力和支持的权限场景：

1. 客户端权限模型

   > **客户端可能需要支持多源权限，而且权限模型不依赖业务平台权限模型。**。
   >
   > 例如在一个租户登录的状态下，可能同时存在：平台侧的权限、应用本地的权限（如用户设置）、终端权限(如：对讲手机、Android8.0 手机)。

2. 权限管理组件

   > **由全局单一的权限组件对权限操作进行管理**，包括`鉴权组件`、`持久化组件` 和 `总线组件`，并提供 listener 机制，允许外部捕获权限变更事件。

3. 权限控件

   > **权限+控件=权限控件。**
   >
   > 权限作为权限控件的自有属性（支持在 layout.xml 的定义），将控制控件的渲染方式（多种方式），提供标准权限控件（1-2 个)；提供权限控件开发模型，允许将普通控件扩展为权限控件；权限控件可以在监听到权限变化后,自动进行重新渲染。

4. 权限表达式

   > **支持权限表达式，能够精简、直观表达权限逻辑**。
   >
   > 除了`精确匹配` 外，还应支持`通配符`、`与操作符`、`或操作符`、`非操作符`及它们的组合. 前期设计应考虑支持解析器扩展。

5. 权限注解

   > **支持方法、组件级别的权限注解，避免 `if-else风暴`**。
   >
   > 通过字节码注入技术，自动注入权限判断逻辑，在满足业务需求的前提下，避免`if-else风暴`，提升代码可读性。

---

## 4. 工程设计原则

工程设计应该遵循以下原则：

1. 最小依赖

   > 将对外部组件的依赖程度降低到最小，避免依赖冲突，减少组件大小。避免使用高级 API，降低对系统要求。

2. 按需使用

   > 合理划分 Module。调用者可以根据需要选择所需 Module

3. 便于使用

   > 支持通过 Maven、Gradle 进行组件及依赖管理。

4. 便于重构

   > 框架模型要足够简单、具备一般适用性。可以通过适配器进行业务平台权限模型与框架模型的转换。重构后代码便于阅读、维护。

---

## 5. 模块设计

工程可以采用通用的 lib 库划分结构，初步分为：核心库 core、控件库 widget、注解库 annotation、plugin、buildSrc 以及 样例库 app

### 5.1 核心库 core

`核心库`的主要职责是符合提供统一的权限管理组件，除了提供全局 PermissionMananger 单例外，将权限业务拆分为以下 3 个组件：

- 鉴权组件

> 主要职责是对当前租户所持有的权限管理，提供权限表达式规则校验的支持，对校验结果进行二级缓存。

- 存储组件

> 主要职责是按 key 提供对权限的持久化、缓存、序列化的支持。它管理了终端上所有的权限。

- 总线组件

> 主要负责对权限变更状态的分发，比如支撑权限控件响应权限变化进行再次渲染

![](https://doulala.oss-cn-qingdao.aliyuncs.com/image/%E6%9D%83%E9%99%90%E6%A0%B8%E5%BF%83%E7%B1%BB%E5%9B%BE.png)

### 5.2 控件库 widget

> 主要提供了一组依赖权限的基础控件，并提供控件权限扩展所需组件，将权限管理的加入控件生命周期，而对权限响应效果进行抽象对外提供。借鉴了前端的标签的设计思想。同时可以利用权限 bus 自动对权限变更事件进行响应，简化了对权限变化后，对大量相关控件的处理。

### 5.3 权限注入库

> 由 annotation、plugin、buildSrc(调试插件用) 三个模块组成。他们结合在一起，利用字节码技术，完成对 `方法` 及 `组件`进行权限化注入，支持自定义回调。

---

## 6. 设计优化

1.【存储优化】使用二级缓存提升权限读取性能

2.【存储优化】按组管理权限，面对局部的权限变化，最大限度减低回源次数。

3.【校验器优化】使用缓存暂存结果，减少运算次数。

4.【算法优化】在逆波兰算法基础上进行运算算法优化，支持类似“!”的单元素操作符。

5.【插件框架】提供基于 ASM 技术的字节码注入框架。通过定义多个【操作帧】，对类级别、方法级别的注解进行依次注入。

6.【部署优化】利用 jenkins 进行 docker 镜像发布、自动部署。

---

## 7. 展望

一直以来，权限管理是最需要前后各端配合的功能，Android 端的这次尝试也最多只是代表前端向前迈了一小步，希望 OhMyPermission 的权限表达式、权限控件的设计理念在经过验证和优化后，可以有机会向服务器端（如加入权限表达式的 RestMapping 注解）、web 前端、iOS 端延伸。

盼望有更有经验的架构师参与指导，对它进行统一的规划和代码的重构，对性能进行进一步调优，希望这次比赛是它的起点，而非终点。
